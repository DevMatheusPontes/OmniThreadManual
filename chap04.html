<!DOCTYPE html>
<html lang="en">

<!-- Mirrored from www.omnithreadlibrary.com/book/chap04.html by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 19 Oct 2025 22:28:24 GMT -->
<head>
  <meta charset="utf-8">
  <title>1. Introduction to multi-threading</title>
  <link href="stylesheet.css" rel="stylesheet" />
</head>
<body dir="ltr" class="kramdown">
<div id="leanpub-toc">
<h2></h2>
<ol class="toc">
<ul class='toc no-parts'>
  <li>
    <a href='chap00.html#intro-advert'>About me</a>
  </li>
  <li>
    <a href='chap01.html#credits'>Credits</a>
  </li>
  <li>
    <a href='chap02.html#introduction'>Introduction</a>
    <ul>
      <li>
        <a href='chap02.html#leanpub-auto-formatting-conventions'>Formatting conventions</a>
      </li>
      <li>
        <a href='chap02.html#leanpub-auto-learn-more'>Learn more</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='chap03.html#leanpub-auto-release-notes'>Release notes</a>
  </li>
  <li>
    <a href='chap04.html#intro-mt'><span class="section-number">1. </span>Introduction to multi-threading</a>
    <ul>
      <li>
        <a href='chap04.html#leanpub-auto-multi-threading-as-a-source-of-problems'><span class="section-number">1.1 </span>Multi-threading as a source of problems</a>
        <ul>
          <li>
            <a href='chap04.html#leanpub-auto-reading-and-writing-shared-data'><span class="section-number">1.1.1 </span>Reading and writing shared data</a>
          </li>
          <li>
            <a href='chap04.html#leanpub-auto-modifying-shared-data'><span class="section-number">1.1.2 </span>Modifying shared data</a>
          </li>
          <li>
            <a href='chap04.html#leanpub-auto-writes-masquerading-as-reads'><span class="section-number">1.1.3 </span>Writes masquerading as reads</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href='chap05.html#intro-otl'><span class="section-number">2. </span>Introduction to OmniThreadLibrary</a>
    <ul>
      <li>
        <a href='chap05.html#leanpub-auto-requirements'><span class="section-number">2.1 </span>Requirements</a>
      </li>
      <li>
        <a href='chap05.html#leanpub-auto-license'><span class="section-number">2.2 </span>License</a>
      </li>
      <li>
        <a href='chap05.html#installation'><span class="section-number">2.3 </span>Installation</a>
        <ul>
          <li>
            <a href='chap05.html#appendix-installing-getit'><span class="section-number">2.3.1 </span>Installing with GetIt</a>
          </li>
          <li>
            <a href='chap05.html#appendix-installing-delphinus'><span class="section-number">2.3.2 </span>Installing with Delphinus</a>
          </li>
          <li>
            <a href='chap05.html#leanpub-auto-installing-design-package'><span class="section-number">2.3.3 </span>Installing design package</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='chap05.html#leanpub-auto-why-use-omnithreadlibrary'><span class="section-number">2.4 </span>Why use OmniThreadLibrary?</a>
      </li>
      <li>
        <a href='chap05.html#introotl-tasksvsthreads'><span class="section-number">2.5 </span>Tasks vs. threads</a>
      </li>
      <li>
        <a href='chap05.html#introotl-lockingvsmessaging'><span class="section-number">2.6 </span>Locking vs. messaging</a>
      </li>
      <li>
        <a href='chap05.html#introotl-messagelooprequired'><span class="section-number">2.7 </span>Message loop required</a>
        <ul>
          <li>
            <a href='chap05.html#introotl-messagelooprequired-console'><span class="section-number">2.7.1 </span>OmniThreadLibrary and console</a>
          </li>
          <li>
            <a href='chap05.html#leanpub-auto-omnithreadlibrary-task-started-from-another-task'><span class="section-number">2.7.2 </span>OmniThreadLibrary task started from another task</a>
          </li>
          <li>
            <a href='chap05.html#leanpub-auto-omnithreadlibrary-task-started-from-a-tthread'><span class="section-number">2.7.3 </span>OmniThreadLibrary task started from a TThread</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='chap05.html#introotl-tomnivalue'><span class="section-number">2.8 </span>TOmniValue</a>
        <ul>
          <li>
            <a href='chap05.html#leanpub-auto-data-access'><span class="section-number">2.8.1 </span>Data access</a>
          </li>
          <li>
            <a href='chap05.html#introotl-tomnivalue-typetesting'><span class="section-number">2.8.2 </span>Type testing</a>
          </li>
          <li>
            <a href='chap05.html#introotl-tomnivalue-clearing'><span class="section-number">2.8.3 </span>Clearing the content</a>
          </li>
          <li>
            <a href='chap05.html#leanpub-auto-operators'><span class="section-number">2.8.4 </span>Operators</a>
          </li>
          <li>
            <a href='chap05.html#introotl-tomnivalue-generictypes'><span class="section-number">2.8.5 </span>Using with generic types</a>
          </li>
          <li>
            <a href='chap05.html#introotl-tomnivalue-array'><span class="section-number">2.8.6 </span>Array access</a>
          </li>
          <li>
            <a href='chap05.html#introotl-tomnivalue-records'><span class="section-number">2.8.7 </span>Handling records</a>
          </li>
          <li>
            <a href='chap05.html#leanpub-auto-object-ownership'><span class="section-number">2.8.8 </span>Object ownership</a>
          </li>
          <li>
            <a href='chap05.html#leanpub-auto-working-with-tvalue'><span class="section-number">2.8.9 </span>Working with TValue</a>
          </li>
          <li>
            <a href='chap05.html#leanpub-auto-low-level-methods'><span class="section-number">2.8.10 </span>Low-level methods</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='chap05.html#leanpub-auto-tomnivalueobj'><span class="section-number">2.9 </span>TOmniValueObj</a>
      </li>
      <li>
        <a href='chap05.html#introotl-fluentinterfaces'><span class="section-number">2.10 </span>Fluent interfaces</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='chap06.html#highlevel'><span class="section-number">3. </span>High-level multi-threading</a>
    <ul>
      <li>
        <a href='chap06.html#highlevel-introduction'><span class="section-number">3.1 </span>Introduction</a>
        <ul>
          <li>
            <a href='chap06.html#leanpub-auto-a-life-cycle-of-an-abstraction'><span class="section-number">3.1.1 </span>A life cycle of an abstraction</a>
          </li>
          <li>
            <a href='chap06.html#highLevel-intro-AnonymousEtAl'><span class="section-number">3.1.2 </span>Anonymous methods, procedures, and methods</a>
          </li>
          <li>
            <a href='chap06.html#highlevel-introduction-pooling'><span class="section-number">3.1.3 </span>Pooling</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='chap06.html#highlevel-blocking-collection'><span class="section-number">3.2 </span>Blocking collection</a>
        <ul>
          <li>
            <a href='chap06.html#highlevel-blocking-collection-iomniblockingcollection'><span class="section-number">3.2.1 </span>IOmniBlockingCollection</a>
          </li>
          <li>
            <a href='chap06.html#highlevel-blocking-collection-bulk-impexp'><span class="section-number">3.2.2 </span>Bulk import and export</a>
          </li>
          <li>
            <a href='chap06.html#highlevel-blocking-collection-throttling'><span class="section-number">3.2.3 </span>Throttling</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='chap06.html#highlevel-taskconfig'><span class="section-number">3.3 </span>Task configuration</a>
      </li>
      <li>
        <a href='chap06.html#highlevel-async'><span class="section-number">3.4 </span>Async</a>
        <ul>
          <li>
            <a href='chap06.html#leanpub-auto-handling-exceptions'><span class="section-number">3.4.1 </span>Handling exceptions</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='chap06.html#highlevel-asyncawait'><span class="section-number">3.5 </span>Async/Await</a>
      </li>
      <li>
        <a href='chap06.html#highlevel-future'><span class="section-number">3.6 </span>Future</a>
        <ul>
          <li>
            <a href='chap06.html#leanpub-auto-iomnifuturet-interface'><span class="section-number">3.6.1 </span>IOmniFuture&lt;T&gt; interface</a>
          </li>
          <li>
            <a href='chap06.html#leanpub-auto-completion-detection'><span class="section-number">3.6.2 </span>Completion detection</a>
          </li>
          <li>
            <a href='chap06.html#leanpub-auto-cancellation'><span class="section-number">3.6.3 </span>Cancellation</a>
          </li>
          <li>
            <a href='chap06.html#leanpub-auto-handling-exceptions-1'><span class="section-number">3.6.4 </span>Handling exceptions</a>
          </li>
          <li>
            <a href='chap06.html#leanpub-auto-examples'><span class="section-number">3.6.5 </span>Examples</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='chap06.html#highlevel-join'><span class="section-number">3.7 </span>Join</a>
        <ul>
          <li>
            <a href='chap06.html#leanpub-auto-iomniparalleljoin-interface'><span class="section-number">3.7.1 </span>IOmniParallelJoin interface</a>
          </li>
          <li>
            <a href='chap06.html#leanpub-auto-iomnijoinstate-interface'><span class="section-number">3.7.2 </span>IOmniJoinState interface</a>
          </li>
          <li>
            <a href='chap06.html#leanpub-auto-cancellation-1'><span class="section-number">3.7.3 </span>Cancellation</a>
          </li>
          <li>
            <a href='chap06.html#highlevel-join-exceptions'><span class="section-number">3.7.4 </span>Handling exceptions</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='chap06.html#highlevel-paralleltask'><span class="section-number">3.8 </span>Parallel task</a>
        <ul>
          <li>
            <a href='chap06.html#leanpub-auto-iomniparalleltask-interface'><span class="section-number">3.8.1 </span>IOmniParallelTask interface</a>
          </li>
          <li>
            <a href='chap06.html#leanpub-auto-example'><span class="section-number">3.8.2 </span>Example</a>
          </li>
          <li>
            <a href='chap06.html#leanpub-auto-handling-exceptions-2'><span class="section-number">3.8.3 </span>Handling exceptions</a>
          </li>
          <li>
            <a href='chap06.html#leanpub-auto-examples-1'><span class="section-number">3.8.4 </span>Examples</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='chap06.html#highlevel-backgroundworker'><span class="section-number">3.9 </span>Background worker</a>
        <ul>
          <li>
            <a href='chap06.html#leanpub-auto-basics'><span class="section-number">3.9.1 </span>Basics</a>
          </li>
          <li>
            <a href='chap06.html#leanpub-auto-iomnibackgroundworker-interface'><span class="section-number">3.9.2 </span>IOmniBackgroundWorker interface</a>
          </li>
          <li>
            <a href='chap06.html#highlevel-backgroundworker-initialization'><span class="section-number">3.9.3 </span>Task initialization</a>
          </li>
          <li>
            <a href='chap06.html#leanpub-auto-work-item-configuration'><span class="section-number">3.9.4 </span>Work item configuration</a>
          </li>
          <li>
            <a href='chap06.html#highlevel-backgroundworker-iomniworkitem'><span class="section-number">3.9.5 </span>Work item interface</a>
          </li>
          <li>
            <a href='chap06.html#leanpub-auto-examples-2'><span class="section-number">3.9.6 </span>Examples</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='chap06.html#highlevel-pipeline'><span class="section-number">3.10 </span>Pipeline</a>
        <ul>
          <li>
            <a href='chap06.html#leanpub-auto-background'><span class="section-number">3.10.1 </span>Background</a>
          </li>
          <li>
            <a href='chap06.html#leanpub-auto-basics-1'><span class="section-number">3.10.2 </span>Basics</a>
          </li>
          <li>
            <a href='chap06.html#leanpub-auto-iomnipipeline-interface'><span class="section-number">3.10.3 </span>IOmniPipeline interface</a>
            <ul>
              <li>
                <a href='chap06.html#leanpub-auto-example-1'><span class="section-number">3.10.3.1 </span>Example</a>
              </li>
            </ul>
          </li>
          <li>
            <a href='chap06.html#leanpub-auto-generators-mutators-and-aggregators'><span class="section-number">3.10.4 </span>Generators, mutators, and aggregators</a>
          </li>
          <li>
            <a href='chap06.html#highlevel-pipeline-throttling'><span class="section-number">3.10.5 </span>Throttling</a>
          </li>
          <li>
            <a href='chap06.html#highlevel-pipeline-parallel'><span class="section-number">3.10.6 </span>Parallel stages</a>
          </li>
          <li>
            <a href='chap06.html#highlevel-pipeline-exceptions'><span class="section-number">3.10.7 </span>Exceptions</a>
          </li>
          <li>
            <a href='chap06.html#leanpub-auto-examples-3'><span class="section-number">3.10.8 </span>Examples</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='chap06.html#highlevel-for'><span class="section-number">3.11 </span>Parallel for</a>
        <ul>
          <li>
            <a href='chap06.html#highlevel-for-iomniparallelsimpleloop'><span class="section-number">3.11.1 </span>IOmniParallelSimpleLoop interface</a>
          </li>
          <li>
            <a href='chap06.html#leanpub-auto-iterating-over-an-array'><span class="section-number">3.11.2 </span>Iterating over an array</a>
          </li>
          <li>
            <a href='chap06.html#leanpub-auto-examples-4'><span class="section-number">3.11.3 </span>Examples</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='chap06.html#highlevel-foreach'><span class="section-number">3.12 </span>ForEach</a>
        <ul>
          <li>
            <a href='chap06.html#leanpub-auto-cooperation'><span class="section-number">3.12.1 </span>Cooperation</a>
          </li>
          <li>
            <a href='chap06.html#leanpub-auto-iterating-over-'><span class="section-number">3.12.2 </span>Iterating over …</a>
            <ul>
              <li>
                <a href='chap06.html#leanpub-auto-number-ranges'><span class="section-number">3.12.2.1 </span>… Number ranges</a>
              </li>
              <li>
                <a href='chap06.html#leanpub-auto-enumerable-collections'><span class="section-number">3.12.2.2 </span>… Enumerable collections</a>
              </li>
              <li>
                <a href='chap06.html#leanpub-auto-thread-safe-enumerable-collections'><span class="section-number">3.12.2.3 </span>… Thread-safe enumerable collections</a>
              </li>
              <li>
                <a href='chap06.html#leanpub-auto-blocking-collections'><span class="section-number">3.12.2.4 </span>… Blocking collections</a>
              </li>
              <li>
                <a href='chap06.html#leanpub-auto-anything'><span class="section-number">3.12.2.5 </span>… Anything</a>
              </li>
            </ul>
          </li>
          <li>
            <a href='chap06.html#leanpub-auto-providing-external-input'><span class="section-number">3.12.3 </span>Providing external input</a>
          </li>
          <li>
            <a href='chap06.html#leanpub-auto-iomniparallelloop-interface'><span class="section-number">3.12.4 </span>IOmniParallelLoop interface</a>
          </li>
          <li>
            <a href='chap06.html#highlevel-foreach-preserveorder'><span class="section-number">3.12.5 </span>Preserving output order</a>
          </li>
          <li>
            <a href='chap06.html#highlevel-foreach-aggregation'><span class="section-number">3.12.6 </span>Aggregation</a>
          </li>
          <li>
            <a href='chap06.html#highlevel-foreach-cancellation'><span class="section-number">3.12.7 </span>Cancellation</a>
          </li>
          <li>
            <a href='chap06.html#highlevel-foreach-taskinit'><span class="section-number">3.12.8 </span>Task initialization and finalization</a>
          </li>
          <li>
            <a href='chap06.html#highlevel-foreach-exceptions'><span class="section-number">3.12.9 </span>Handling exceptions</a>
          </li>
          <li>
            <a href='chap06.html#leanpub-auto-examples-5'><span class="section-number">3.12.10 </span>Examples</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='chap06.html#highlevel-forkjoin'><span class="section-number">3.13 </span>Fork/Join</a>
        <ul>
          <li>
            <a href='chap06.html#leanpub-auto-iomniforkjoin-interface'><span class="section-number">3.13.1 </span>IOmniForkJoin interface</a>
          </li>
          <li>
            <a href='chap06.html#leanpub-auto-iomnicompute-interface'><span class="section-number">3.13.2 </span>IOmniCompute interface</a>
          </li>
          <li>
            <a href='chap06.html#leanpub-auto-iomnicomputet-interface'><span class="section-number">3.13.3 </span>IOmniCompute&lt;T&gt; interface</a>
          </li>
          <li>
            <a href='chap06.html#leanpub-auto-exceptions'><span class="section-number">3.13.4 </span>Exceptions</a>
          </li>
          <li>
            <a href='chap06.html#leanpub-auto-examples-6'><span class="section-number">3.13.5 </span>Examples</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='chap06.html#highlevel-map'><span class="section-number">3.14 </span>Map</a>
        <ul>
          <li>
            <a href='chap06.html#leanpub-auto-iomniparallelmappert1t2-interface'><span class="section-number">3.14.1 </span>IOmniParallelMapper&lt;T1,T2&gt; interface</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='chap06.html#highlevel-timedtask'><span class="section-number">3.15 </span>Timed task</a>
        <ul>
          <li>
            <a href='chap06.html#highlevel-timedtask-iomnitimedtask'><span class="section-number">3.15.1 </span>IOmniTimedTask interface</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href='chap07.html#lowlevel'><span class="section-number">4. </span>Low-level multi-threading</a>
    <ul>
      <li>
        <a href='chap07.html#leanpub-auto-low-level-for-the-impatient'><span class="section-number">4.1 </span>Low-level for the impatient</a>
      </li>
      <li>
        <a href='chap07.html#lowlevel-fourways'><span class="section-number">4.2 </span>Four ways to create a task</a>
      </li>
      <li>
        <a href='chap07.html#lowlevel-iomnitaskcontrol'><span class="section-number">4.3 </span>IOmniTaskControl and IOmniTask interfaces</a>
      </li>
      <li>
        <a href='chap07.html#lowlevel-taskControllerOwner'><span class="section-number">4.4 </span>Task controller needs an owner</a>
      </li>
      <li>
        <a href='chap07.html#lowlevel-communication'><span class="section-number">4.5 </span>Communication subsystem</a>
      </li>
      <li>
        <a href='chap07.html#leanpub-auto-processor-groups-and-numa-nodes'><span class="section-number">4.6 </span>Processor groups and NUMA nodes</a>
      </li>
      <li>
        <a href='chap07.html#lowlevel-threadpool'><span class="section-number">4.7 </span>Thread pooling</a>
        <ul>
          <li>
            <a href='chap07.html#leanpub-auto-execution-flow'><span class="section-number">4.7.1 </span>Execution flow</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-threadpool-interface'><span class="section-number">4.7.2 </span>IOmniThreadPool interface</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-threadpool-exitcode'><span class="section-number">4.7.3 </span>Task exit code</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-threadpool-monitoring'><span class="section-number">4.7.4 </span>Monitoring thread pool operations</a>
          </li>
          <li>
            <a href='chap07.html#leanpub-auto-processor-groups-and-numa-nodes-1'><span class="section-number">4.7.5 </span>Processor groups and NUMA nodes</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='chap07.html#lowlevel-lockfree'><span class="section-number">4.8 </span>Lock-free collections</a>
        <ul>
          <li>
            <a href='chap07.html#lowlevel-lockfree-boundedstack'><span class="section-number">4.8.1 </span>Bounded Stack</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-lockfree-boundedqueue'><span class="section-number">4.8.2 </span>Bounded queue</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-lockfree-messagequeue'><span class="section-number">4.8.3 </span>Message queue</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-lockfree-dynamicqueue'><span class="section-number">4.8.4 </span>Dynamic queue</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-lockfree-observing'><span class="section-number">4.8.5 </span>Observing lock-free collections</a>
            <ul>
              <li>
                <a href='chap07.html#leanpub-auto-examples-7'><span class="section-number">4.8.5.1 </span>Examples</a>
              </li>
            </ul>
          </li>
          <li>
            <a href='chap07.html#leanpub-auto-benchmarks'><span class="section-number">4.8.6 </span>Benchmarks</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='chap07.html#lowlevel-eventmonitor'><span class="section-number">4.9 </span>Event monitor</a>
      </li>
      <li>
        <a href='chap07.html#lowlevel-simpletasks'><span class="section-number">4.10 </span>Simple tasks</a>
        <ul>
          <li>
            <a href='chap07.html#lowlevel-simpletasks-name'><span class="section-number">4.10.1 </span>Name</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-simpletasks-uniqueid'><span class="section-number">4.10.2 </span>UniqueID</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-simpletasks-parameters'><span class="section-number">4.10.3 </span>Parameters</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-simpletasks-termination'><span class="section-number">4.10.4 </span>Termination</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-simpletasks-exitcode'><span class="section-number">4.10.5 </span>ExitCode</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-simpletasks-taskexceptions'><span class="section-number">4.10.6 </span>Exceptions</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-simpletasks-communication'><span class="section-number">4.10.7 </span>Sending messages to a task</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-simpletasks-receiving'><span class="section-number">4.10.8 </span>Receiving messages from a task</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-simpletasks-chainto'><span class="section-number">4.10.9 </span>ChainTo</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-simpletasks-joinleave'><span class="section-number">4.10.10 </span>Join / Leave</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-simpletasks-monitorwith'><span class="section-number">4.10.11 </span>MonitorWith / RemoveMonitor</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-simpletasks-enforced'><span class="section-number">4.10.12 </span>Enforced</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-simpletasks-unobserved'><span class="section-number">4.10.13 </span>Unobserved</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-simpletasks-cancellationtoken'><span class="section-number">4.10.14 </span>Cancellation token / CancelWith</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-simpletasks-tasklock'><span class="section-number">4.10.15 </span>Lock / WithLock</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-simpletasks-counter'><span class="section-number">4.10.16 </span>WithCounter</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-simpletasks-setpriority'><span class="section-number">4.10.17 </span>SetPriority</a>
          </li>
          <li>
            <a href='chap07.html#leanpub-auto-setqueuesize'><span class="section-number">4.10.18 </span>SetQueueSize</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='chap07.html#lowlevel-tomniworker'><span class="section-number">4.11 </span>TOmniWorker tasks</a>
        <ul>
          <li>
            <a href='chap07.html#lowlevel-tomniworker-waitforinit'><span class="section-number">4.11.1 </span>WaitForInit</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-tomniworker-task'><span class="section-number">4.11.2 </span>Task</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-tomniworker-communication'><span class="section-number">4.11.3 </span>Receiving messages</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-tomniworker-registercomm'><span class="section-number">4.11.4 </span>RegisterComm</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-tomniworker-tomniworkerinvoke'><span class="section-number">4.11.5 </span>Invoke</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-tomniworker-msgwait'><span class="section-number">4.11.6 </span>Windows message &amp; APC processing</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-tomniworker-timers'><span class="section-number">4.11.7 </span>Timers</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-tomniworker-terminateWhen'><span class="section-number">4.11.8 </span>TerminateWhen</a>
          </li>
          <li>
            <a href='chap07.html#leanpub-auto-userdata'><span class="section-number">4.11.9 </span>UserData</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='chap07.html#lowlevel-taskgroup'><span class="section-number">4.12 </span>Task groups</a>
      </li>
      <li>
        <a href='chap07.html#lowlevel-iomnitask'><span class="section-number">4.13 </span>IOmniTask interface</a>
        <ul>
          <li>
            <a href='chap07.html#leanpub-auto-name-and-id'><span class="section-number">4.13.1 </span>Name and ID</a>
          </li>
          <li>
            <a href='chap07.html#leanpub-auto-parameters'><span class="section-number">4.13.2 </span>Parameters</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-iomnitask-termination'><span class="section-number">4.13.3 </span>Termination</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-iomnitask-exitstatus'><span class="section-number">4.13.4 </span>Exit status</a>
          </li>
          <li>
            <a href='chap07.html#leanpub-auto-exceptions-1'><span class="section-number">4.13.5 </span>Exceptions</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-iomnitask-communication'><span class="section-number">4.13.6 </span>Communication</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-iomnitask-timers'><span class="section-number">4.13.7 </span>Timers</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-iomnitask-registerwaitobject'><span class="section-number">4.13.8 </span>RegisterWaitObject</a>
          </li>
          <li>
            <a href='chap07.html#leanpub-auto-cancellationtoken'><span class="section-number">4.13.9 </span>CancellationToken</a>
          </li>
          <li>
            <a href='chap07.html#lowlevel-iomnitask-lock'><span class="section-number">4.13.10 </span>Lock</a>
          </li>
          <li>
            <a href='chap07.html#leanpub-auto-counter'><span class="section-number">4.13.11 </span>Counter</a>
          </li>
          <li>
            <a href='chap07.html#leanpub-auto-processor-groups-and-numa-nodes-2'><span class="section-number">4.13.12 </span>Processor groups and NUMA nodes</a>
          </li>
          <li>
            <a href='chap07.html#leanpub-auto-internal-and-obsolete-functions'><span class="section-number">4.13.13 </span>Internal and obsolete functions</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href='chap08.html#synch'><span class="section-number">5. </span>Synchronization</a>
    <ul>
      <li>
        <a href='chap08.html#synch-criticalsections'><span class="section-number">5.1 </span>Critical sections</a>
        <ul>
          <li>
            <a href='chap08.html#synch-criticalsections-iomnicriticalsection'><span class="section-number">5.1.1 </span>IOmniCriticalSection</a>
          </li>
          <li>
            <a href='chap08.html#synch-criticalsections-tomnics'><span class="section-number">5.1.2 </span>TOmniCS</a>
          </li>
          <li>
            <a href='chap08.html#synch-criticalsections-lockedt'><span class="section-number">5.1.3 </span>Locked&lt;T&gt;</a>
            <ul>
              <li>
                <a href='chap08.html#leanpub-auto-why-not-use-tmonitor'><span class="section-number">5.1.3.1 </span>Why not use TMonitor?</a>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li>
        <a href='chap08.html#synch-tomnimrew'><span class="section-number">5.2 </span>TOmniMREW</a>
      </li>
      <li>
        <a href='chap08.html#synch-cancellationtoken'><span class="section-number">5.3 </span>Cancellation token</a>
      </li>
      <li>
        <a href='chap08.html#synch-waitablevalue'><span class="section-number">5.4 </span>Waitable value</a>
      </li>
      <li>
        <a href='chap08.html#synch-inversesemaphore'><span class="section-number">5.5 </span>Inverse semaphore</a>
      </li>
      <li>
        <a href='chap08.html#synch-initialization'><span class="section-number">5.6 </span>Initialization</a>
        <ul>
          <li>
            <a href='chap08.html#synch-initialization-pessimistic'><span class="section-number">5.6.1 </span>Pessimistic initialization</a>
          </li>
          <li>
            <a href='chap08.html#synch-initialization-optimistic'><span class="section-number">5.6.2 </span>Optimistic initialization</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='chap08.html#synch-twaitfor'><span class="section-number">5.7 </span>TWaitFor</a>
      </li>
      <li>
        <a href='chap08.html#synch-tomnilockmanager'><span class="section-number">5.8 </span>TOmniLockManager&lt;K&gt;</a>
      </li>
      <li>
        <a href='chap08.html#synch-tomnisinglethreadusechecker'><span class="section-number">5.9 </span>TOmniSingleThreadUseChecker</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='chap09.html#misc'><span class="section-number">6. </span>Miscellaneous</a>
    <ul>
      <li>
        <a href='chap09.html#misc-tOmniTwoWayChannel'><span class="section-number">6.1 </span>TOmniTwoWayChannel</a>
      </li>
      <li>
        <a href='chap09.html#misc-tomnivaluecontainer'><span class="section-number">6.2 </span>TOmniValueContainer</a>
      </li>
      <li>
        <a href='chap09.html#misc-tomnicounter'><span class="section-number">6.3 </span>TOmniCounter</a>
      </li>
      <li>
        <a href='chap09.html#misc-TOmniAlignedInt32'><span class="section-number">6.4 </span>TOmniAlignedInt32 and TOmniAlignedInt64</a>
      </li>
      <li>
        <a href='chap09.html#misc-tomnirecordwrapper'><span class="section-number">6.5 </span>TOmniRecordWrapper</a>
      </li>
      <li>
        <a href='chap09.html#misc-tomnirecord'><span class="section-number">6.6 </span>TOmniRecord</a>
      </li>
      <li>
        <a href='chap09.html#misc-iomniautodestroyobject'><span class="section-number">6.7 </span>IOmniAutoDestroyObject</a>
      </li>
      <li>
        <a href='chap09.html#misc-iomniintegerset'><span class="section-number">6.8 </span>IOmniIntegerSet</a>
      </li>
      <li>
        <a href='chap09.html#misc-environment'><span class="section-number">6.9 </span>Environment</a>
        <ul>
          <li>
            <a href='chap09.html#leanpub-auto-iomniaffinity'><span class="section-number">6.9.1 </span>IOmniAffinity</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href='chap10.html#howto'><span class="section-number">7. </span>How-to</a>
    <ul>
      <li>
        <a href='chap10.html#howto-backgroundFileScanning'><span class="section-number">7.1 </span>Background file scanning</a>
      </li>
      <li>
        <a href='chap10.html#howto-webDownload'><span class="section-number">7.2 </span>Web download and database storage</a>
      </li>
      <li>
        <a href='chap10.html#howto-parallelForSyncOut'><span class="section-number">7.3 </span>Parallel for with synchronized output</a>
      </li>
      <li>
        <a href='chap10.html#howto-parallelForTaskInit'><span class="section-number">7.4 </span>Using taskIndex and task initializer in parallel for</a>
      </li>
      <li>
        <a href='chap10.html#howto-listPartitioning'><span class="section-number">7.5 </span>Background worker and list partitioning</a>
      </li>
      <li>
        <a href='chap10.html#howto-parallelDataProduction'><span class="section-number">7.6 </span>Parallel data production</a>
      </li>
      <li>
        <a href='chap10.html#howto-connectionPool'><span class="section-number">7.7 </span>Building a connection pool</a>
        <ul>
          <li>
            <a href='chap10.html#leanpub-auto-from-theory-to-practice'><span class="section-number">7.7.1 </span>From theory to practice</a>
          </li>
          <li>
            <a href='chap10.html#leanpub-auto-running-the-demo'><span class="section-number">7.7.2 </span>Running the demo</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='chap10.html#howto-quickSortParallelMax'><span class="section-number">7.8 </span>QuickSort and parallel max</a>
        <ul>
          <li>
            <a href='chap10.html#leanpub-auto-quicksort'><span class="section-number">7.8.1 </span>QuickSort</a>
          </li>
          <li>
            <a href='chap10.html#leanpub-auto-parallel-max'><span class="section-number">7.8.2 </span>Parallel max</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='chap10.html#howto-parallelSearch'><span class="section-number">7.9 </span>Parallel search in a tree</a>
      </li>
      <li>
        <a href='chap10.html#howto-multiFrame'><span class="section-number">7.10 </span>Multiple workers with multiple frames</a>
        <ul>
          <li>
            <a href='chap10.html#leanpub-auto-the-worker'><span class="section-number">7.10.1 </span>The worker</a>
          </li>
          <li>
            <a href='chap10.html#leanpub-auto-the-frame'><span class="section-number">7.10.2 </span>The frame</a>
          </li>
          <li>
            <a href='chap10.html#leanpub-auto-the-form'><span class="section-number">7.10.3 </span>The form</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='chap10.html#howto-databases'><span class="section-number">7.11 </span>OmniThreadLibrary and databases</a>
        <ul>
          <li>
            <a href='chap10.html#leanpub-auto-database-model'><span class="section-number">7.11.1 </span>Database model</a>
          </li>
          <li>
            <a href='chap10.html#leanpub-auto-frame-and-worker'><span class="section-number">7.11.2 </span>Frame and worker</a>
            <ul>
              <li>
                <a href='chap10.html#leanpub-auto-connecting-to-the-database'><span class="section-number">7.11.2.1 </span>Connecting to the database</a>
              </li>
              <li>
                <a href='chap10.html#leanpub-auto-retrieving-the-data'><span class="section-number">7.11.2.2 </span>Retrieving the data</a>
              </li>
            </ul>
          </li>
          <li>
            <a href='chap10.html#leanpub-auto-main-program'><span class="section-number">7.11.3 </span>Main program</a>
          </li>
        </ul>
      </li>
      <li>
        <a href='chap10.html#howto-com'><span class="section-number">7.12 </span>OmniThreadLibrary and COM/OLE</a>
      </li>
      <li>
        <a href='chap10.html#howto-mqtthread'><span class="section-number">7.13 </span>Using a message queue with a TThread worker</a>
        <ul>
          <li>
            <a href='chap10.html#leanpub-auto-sending-data-from-multiple-producers-to-a-single-worker'><span class="section-number">7.13.1 </span>Sending data from multiple producers to a single worker</a>
            <ul>
              <li>
                <a href='chap10.html#leanpub-auto-initialization-and-cleanup'><span class="section-number">7.13.1.1 </span>Initialization and cleanup</a>
              </li>
              <li>
                <a href='chap10.html#leanpub-auto-sending-data-to-the-worker'><span class="section-number">7.13.1.2 </span>Sending data to the worker</a>
              </li>
              <li>
                <a href='chap10.html#leanpub-auto-receiving-the-data'><span class="section-number">7.13.1.3 </span>Receiving the data</a>
              </li>
            </ul>
          </li>
          <li>
            <a href='chap10.html#leanpub-auto-sending-data-from-a-worker-to-a-form'><span class="section-number">7.13.2 </span>Sending data from a worker to a form</a>
            <ul>
              <li>
                <a href='chap10.html#leanpub-auto-initialization-and-cleanup-1'><span class="section-number">7.13.2.1 </span>Initialization and cleanup</a>
              </li>
              <li>
                <a href='chap10.html#leanpub-auto-sending-data-to-the-form'><span class="section-number">7.13.2.2 </span>Sending data to the form</a>
              </li>
              <li>
                <a href='chap10.html#leanpub-auto-receiving-the-data-1'><span class="section-number">7.13.2.3 </span>Receiving the data</a>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href='chap11.html#appendix-units'>A. Units</a>
  </li>
  <li>
    <a href='chap12.html#demos'>B. Demo applications</a>
  </li>
  <li>
    <a href='chap13.html#examples'>C. Examples</a>
  </li>
  <li>
    <a href='chap14.html#appendix-hooking'>D. Hooking into OmniThreadLibrary</a>
    <ul>
      <li>
        <a href='chap14.html#leanpub-auto-exception-notifications'>Exception notifications</a>
      </li>
      <li>
        <a href='chap14.html#leanpub-auto-thread-notifications'>Thread notifications</a>
      </li>
      <li>
        <a href='chap14.html#leanpub-auto-pool-notifications'>Pool notifications</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='chap15.html#highlevel-foreach-internals'>E. ForEach internals</a>
    <ul>
      <li>
        <a href='chap15.html#leanpub-auto-source-provider'>Source provider</a>
      </li>
      <li>
        <a href='chap15.html#leanpub-auto-data-manager'>Data manager</a>
      </li>
      <li>
        <a href='chap15.html#leanpub-auto-local-queue'>Local queue</a>
      </li>
      <li>
        <a href='chap15.html#leanpub-auto-output-ordering'>Output ordering</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='chap16.html#leanpub-auto-f-hyperlinks'>F. Hyperlinks</a>
  </li>
  <li>
    <a href='chap17.html#leanpub-endnotes'>Notes</a>
  </li>
</ul>

</ol>
</div>
<div id="leanpub-main" class="kramdown">
<h2 id="intro-mt">
<span class="section-number">1. </span>Introduction to multi-threading</h2>

<p>You may have heard about <em>threads</em> and <em>multi-threading</em> already, but you may not exactly know what those words mean. The precise definition is not important for this story. What is important are the general ideas. If you want to read more, start with the entry in <a href="https://en.wikipedia.org/wiki/Thread_(computing)">Wikipedia</a>. If you are well versed in these topics, you can freely skip ahead to the next chapter, <a href="chap05.html#intro-otl">Introduction to OTL</a>.</p>

<p>When you start a program, the operating system creates internal entity called a <em>process</em>. It contains almost everything that an operating system associates with the started program - allocated memory, open file and window handles, sockets and so on. A process, however, does <strong>not</strong> contain the information related to the CPU state. That is part of a <em>thread</em>. </p>

<p>A <em>thread</em> encapsulates the state of the CPU registers, thread stack and <em>thread local variables</em>. Every process contains one thread - the <em>main thread</em>. Operating system creates it together with a process when it starts a program. </p>

<p>Modern operating systems allow multiple threads of execution inside a process. This is achieved by creating additional <em>background threads</em> in the code. To create a thread we can use operating system primitives (such as <code>CreateThread</code> on Windows), low-level run-time library functionality as Delphi’s <code>TThread</code>, or higher-level concepts such as <a href="chap07.html#lowlevel">tasks</a> and <a href="chap06.html#highlevel-introduction">abstractions</a> (also known as patterns). </p>

<p>On a multi-CPU machine these threads can execute in parallel, one on each core. A typical computer system, however, runs much more threads than it has CPUs and that’s where <em>multi-threading</em> kicks in. </p>

<p>A multi-threading is not a recent invention. It appeared decades before multiprocessor boards became available to the general public. In a typical multi-threading system the operating system allows a thread to run for some time (typically few milliseconds) and then stores the thread’s state (registers etc) into the operating system’s internal data structures and activates some other thread. By quickly switching between multiple threads the system gives an illusion of running many threads in many programs in parallel.</p>


<h3 id="leanpub-auto-multi-threading-as-a-source-of-problems">
<span class="section-number">1.1 </span>Multi-threading as a source of problems</h3>

<p>Multi-threading is a powerful concept, but it also brings many problems. They are all consequence of the same fact – that threads are not <em>isolated</em>. </p>

<p>An operating system works hard to isolate one process from another. This prevents one process from accessing the memory belonging to another, which is an important security feature. It also makes sure that a bug in one process won’t affect any other process in the system. If you think that’s nothing special, you are not old enough. Some of us had to work on Windows 3 which had no such isolation and we still remember how one badly behaved application could bring down the whole system. </p>

<p>Since threads are not isolated, each thread can access all the memory memory belonging to a process. This gives us extreme power and flexibility. Starting multiple threads provides all the threads with access to the same data. It is also a source of all problems. If multiple threads don’t only <em>read</em> from the shared data but <em>write</em> to it, you’ll get into trouble.</p>

<p>It should be obvious that one thread must not modify data while another thread is reading from it. It is harder to enforce this in practice. We can protect access to shared data by using locking (critical sections, spinlocks, <code>TMonitor</code> …) or interlocked operations, but they will slow the program down and they can introduce new problems (deadlocks). </p>

<p>That is why I prefer <em>data copying</em>, <em>communications</em> and <em>aggregation</em> over data sharing. Modern CPUs are fast and they can easily copy few tens or hundreds of bytes that are then sent to the thread so it can work on its own copy of the data and not on shared data. This approach is the basis of OmniThreadLibrary and you’ll see it throughout the book. </p>

<p>To write better code, you should know which operations that are completely safe in a single-threaded world will get you in trouble when you are multi-threading. </p>

<h4 id="leanpub-auto-reading-and-writing-shared-data">
<span class="section-number">1.1.1 </span>Reading and writing shared data</h4>

<p>Let’s start with simple variable access. One thread is reading from a variable and another is writing to it. </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">var</code> 
<code class="lineno">2 </code>  <code class="n">a</code><code class="o">,</code><code class="n">b</code><code class="o">:</code> <code class="kt">integer</code><code class="o">;</code> 
<code class="lineno">3 </code>   
<code class="lineno">4 </code><code class="c1">// thread 1 </code>
<code class="lineno">5 </code><code class="n">a</code> <code class="o">:=</code> <code class="mi">42</code><code class="o">;</code> 
<code class="lineno">6 </code><code class="c1">// thread 2 </code>
<code class="lineno">7 </code><code class="n">b</code> <code class="o">:=</code> <code class="n">a</code><code class="o">;</code> 
</pre></div>

</figure>

<p>This looks safe. Variable <code>b</code> will contain either <em>42</em> or previous data stored in <code>a</code>. Well, that is not entirely true. <code>b</code> may also contain a mixture of both. </p>

<p>Depending on how the <code>a</code> is stored in memory (how it is <em>aligned</em>) the processor will access it either with one or two operations. If two operations are used, a read operation may partially overlap the write operation. For example, the code may read the first part of <code>a</code>, then <code>a</code> gets fully updated and only then the code reads the second part of <code>a</code>. </p>

<p>This code behaves “as expected” (doesn’t cause problems) if the <em>address of <code>a</code></em> gives remainder of <em>0</em> when divided by <code>4</code>. We say that <code>a</code> is <em>4-aligned</em>. Delphi in most cases makes all integers 4-aligned. Sadly, in some occasions, especially when structured types – classes and records – are nested, variables are not well-aligned. </p>

<aside class="information blurb">
    <p>We say the operation is <em>atomic</em> if it is performed in one step. Reads and writes of 4-aligned integers are atomic on Intel platform. </p>

</aside>

<p>The simplest way to be sure that a value is correctly aligned is to use the <a href="chap09.html#misc-TOmniAlignedInt32"><code>TOmniAlignedInt32</code></a> record provided by the OmniThreadLibrary. It makes sure that the underlying data storage is correctly aligned and can as such be accessed atomically. </p>

<p>OmniThreadLibrary also implements <a href="chap09.html#misc-TOmniAlignedInt32"><code>TOmniAlignedInt64</code></a> type which creates 8-aligned <code>int64</code> data. This data may be accessed atomically only from 64-bit code. </p>

<aside class="warning blurb">
    <p>Reads and writes of 8-aligned <code>int64</code>s are atomic only in 64-bit code. </p>

  <p><code>TOmniAlignedInt64</code> implements atomic operations on <code>int64</code>s that can be used in 32-bit code. </p>

</aside>

<h4 id="leanpub-auto-modifying-shared-data">
<span class="section-number">1.1.2 </span>Modifying shared data</h4>

<p>Another example of typical code that doesn’t work correctly in a multi-threaded environment is modifying the same data from two threads. In a typical program this data modification is hidden inside an operation we think of as <em>atomic</em> while in reality it isn’t. </p>

<p>A standard example of this problem is implemented with two threads, one incrementing the shared value and other decrementing it. </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="k">var</code> 
<code class="lineno"> 2 </code>  <code class="n">data</code><code class="o">:</code> <code class="kt">integer</code><code class="o">;</code> 
<code class="lineno"> 3 </code>   
<code class="lineno"> 4 </code><code class="n">data</code> <code class="o">:=</code> <code class="mi">0</code><code class="o">;</code> 
<code class="lineno"> 5 </code>   
<code class="lineno"> 6 </code><code class="c1">// thread 1 </code>
<code class="lineno"> 7 </code><code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="mi">1</code> <code class="k">to</code> <code class="mi">100000</code> <code class="k">do</code> 
<code class="lineno"> 8 </code>  <code class="nb">Inc</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code class="o">;</code> 
<code class="lineno"> 9 </code><code class="c1">// thread 2 </code>
<code class="lineno">10 </code><code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="mi">1</code> <code class="k">to</code> <code class="mi">100000</code> <code class="k">do</code> 
<code class="lineno">11 </code>  <code class="nb">Dec</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code class="o">;</code> 
</pre></div>

</figure>

<p>In a single-threaded world, the value of <code>data</code> is <em>0</em> when this pseudo-code finishes. In a multi-threaded scenario, however, it will lie somewhere between <em>-100000</em> and <em>100000</em> – and that’s all we can say. </p>

<p>The problem with this code is that <code>Inc</code> and <code>Dec</code> are not atomic operations. Rather, they are implemented inside the CPU as a series of three operations – <em>read data from memory</em>, <em>increment (or decrement) data</em>, and <em>write data to memory</em>. </p>

<p>One way to fix such code is to use already mentioned <code>TOmniAlignedInt32</code> which implements atomic <code>Increment</code> and <code>Decrement</code> operations. </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="k">var</code> 
<code class="lineno"> 2 </code>  <code class="n">data</code><code class="o">:</code> <code class="n">TOmniAlignedInt32</code><code class="o">;</code> 
<code class="lineno"> 3 </code>   
<code class="lineno"> 4 </code><code class="n">data</code> <code class="o">:=</code> <code class="mi">0</code><code class="o">;</code> 
<code class="lineno"> 5 </code>   
<code class="lineno"> 6 </code><code class="c1">// thread 1 </code>
<code class="lineno"> 7 </code><code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="mi">1</code> <code class="k">to</code> <code class="mi">100000</code> <code class="k">do</code> 
<code class="lineno"> 8 </code>  <code class="n">data</code><code class="o">.</code><code class="n">Increment</code><code class="o">;</code> 
<code class="lineno"> 9 </code><code class="c1">// thread 2 </code>
<code class="lineno">10 </code><code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="mi">1</code> <code class="k">to</code> <code class="mi">100000</code> <code class="k">do</code> 
<code class="lineno">11 </code>  <code class="n">data</code><code class="o">.</code><code class="n">Decrement</code><code class="o">;</code> 
</pre></div>

</figure>

<p>Another option is to use <em>interlocked</em> operations from Delphi’s <em>System.SyncObjs</em> unit. </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="k">var</code> 
<code class="lineno"> 2 </code>  <code class="n">data</code><code class="o">:</code> <code class="kt">integer</code><code class="o">;</code> 
<code class="lineno"> 3 </code>   
<code class="lineno"> 4 </code><code class="n">data</code> <code class="o">:=</code> <code class="mi">0</code><code class="o">;</code> 
<code class="lineno"> 5 </code>   
<code class="lineno"> 6 </code><code class="c1">// thread 1 </code>
<code class="lineno"> 7 </code><code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="mi">1</code> <code class="k">to</code> <code class="mi">100000</code> <code class="k">do</code> 
<code class="lineno"> 8 </code>  <code class="n">TInterlocked</code><code class="o">.</code><code class="n">Increment</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code class="o">;</code> 
<code class="lineno"> 9 </code><code class="c1">// thread b </code>
<code class="lineno">10 </code><code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="mi">1</code> <code class="k">to</code> <code class="mi">100000</code> <code class="k">do</code> 
<code class="lineno">11 </code>  <code class="n">TInterlocked</code><code class="o">.</code><code class="n">Decrement</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code class="o">;</code> 
</pre></div>

</figure>

<p>The third option is to protect increment/decrement operations by wrapping them in a <a href="chap08.html#synch-criticalsections">critical section</a>. You could, for example, use OmniThreadLibrary’s <a href="chap08.html#synch-criticalsections-tomnics"><code>TOmniCS</code></a>. </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="k">var</code> 
<code class="lineno"> 2 </code>  <code class="n">data</code><code class="o">:</code> <code class="kt">integer</code><code class="o">;</code> 
<code class="lineno"> 3 </code>  <code class="n">lock</code><code class="o">:</code> <code class="n">TOmniCS</code><code class="o">;</code> 
<code class="lineno"> 4 </code>   
<code class="lineno"> 5 </code><code class="n">data</code> <code class="o">:=</code> <code class="mi">0</code><code class="o">;</code> 
<code class="lineno"> 6 </code>   
<code class="lineno"> 7 </code><code class="c1">// thread 1 </code>
<code class="lineno"> 8 </code><code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="mi">1</code> <code class="k">to</code> <code class="mi">100000</code> <code class="k">do</code> <code class="k">begin</code> 
<code class="lineno"> 9 </code>  <code class="n">lock</code><code class="o">.</code><code class="n">Acquire</code><code class="o">;</code> 
<code class="lineno">10 </code>  <code class="n">data</code><code class="o">.</code><code class="n">Increment</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code class="o">;</code> 
<code class="lineno">11 </code>  <code class="n">lock</code><code class="o">.</code><code class="n">Release</code><code class="o">;</code> 
<code class="lineno">12 </code><code class="k">end</code><code class="o">;</code> 
<code class="lineno">13 </code>
<code class="lineno">14 </code><code class="c1">// thread 2 </code>
<code class="lineno">15 </code><code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="mi">1</code> <code class="k">to</code> <code class="mi">100000</code> <code class="k">do</code> <code class="k">begin</code> 
<code class="lineno">16 </code>  <code class="n">lock</code><code class="o">.</code><code class="n">Acquire</code><code class="o">;</code> 
<code class="lineno">17 </code>  <code class="n">data</code><code class="o">.</code><code class="n">Decrement</code><code class="p">(</code><code class="n">data</code><code class="p">)</code><code class="o">;</code> 
<code class="lineno">18 </code>  <code class="n">lock</code><code class="o">.</code><code class="n">Release</code><code class="o">;</code> 
<code class="lineno">19 </code><code class="k">end</code><code class="o">;</code> 
</pre></div>

</figure>

<p>Using interlocked operations is a bit slower than normal arithmetics and locking with critical sections is even slower. That’s one reason I prefer data copying and aggregation over locking.</p>

<p>The next example shows how the increment/decrement example could be rewritten with these principles in mind. </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="lineno"> 1 </code><code class="k">var</code> 
<code class="lineno"> 2 </code>  <code class="n">data</code><code class="o">:</code> <code class="kt">integer</code><code class="o">;</code> 
<code class="lineno"> 3 </code>   
<code class="lineno"> 4 </code><code class="c1">// thread 1 </code>
<code class="lineno"> 5 </code><code class="k">var</code> 
<code class="lineno"> 6 </code>  <code class="n">tempData</code><code class="o">:</code> <code class="kt">integer</code><code class="o">;</code> 
<code class="lineno"> 7 </code>   
<code class="lineno"> 8 </code><code class="n">tempData</code> <code class="o">:=</code> <code class="mi">0</code><code class="o">;</code>   
<code class="lineno"> 9 </code><code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="mi">1</code> <code class="k">to</code> <code class="mi">100000</code> <code class="k">do</code> 
<code class="lineno">10 </code>  <code class="nb">Inc</code><code class="p">(</code><code class="n">tempData</code><code class="p">)</code><code class="o">;</code> 
<code class="lineno">11 </code><code class="n">send</code> <code class="n">tempData</code> <code class="k">to</code> <code class="n">main</code> <code class="n">thread</code> 
<code class="lineno">12 </code>
<code class="lineno">13 </code><code class="c1">// thread 2 </code>
<code class="lineno">14 </code><code class="k">var</code> 
<code class="lineno">15 </code>  <code class="n">tempData</code><code class="o">:</code> <code class="kt">integer</code><code class="o">;</code> 
<code class="lineno">16 </code><code class="n">tempData</code> <code class="o">:=</code> <code class="mi">0</code><code class="o">;</code>   
<code class="lineno">17 </code><code class="k">for</code> <code class="n">i</code> <code class="o">:=</code> <code class="mi">1</code> <code class="k">to</code> <code class="mi">100000</code> <code class="k">do</code> 
<code class="lineno">18 </code>  <code class="nb">Dec</code><code class="p">(</code><code class="n">tempData</code><code class="p">)</code><code class="o">;</code> 
<code class="lineno">19 </code><code class="n">send</code> <code class="n">tempData</code> <code class="k">to</code> <code class="n">main</code> <code class="n">thread</code> 
<code class="lineno">20 </code>   
<code class="lineno">21 </code><code class="c1">// main thread </code>
<code class="lineno">22 </code><code class="n">data</code> <code class="o">:=</code> <code class="bp">result</code> <code class="n">from</code> <code class="n">thread</code> <code class="mi">1</code> <code class="o">+</code> <code class="bp">result</code> <code class="n">from</code> <code class="n">thread</code> <code class="mi">2</code> 
</pre></div>

</figure>

<p>This approach doesn’t manipulate shared data which makes it run faster than <em>interlocked</em> and <em>locking</em> solutions. It does, however, require a communication mechanism that will send data to and from a thread. Different parts of this book will deal with that. </p>

<h4 id="leanpub-auto-writes-masquerading-as-reads">
<span class="section-number">1.1.3 </span>Writes masquerading as reads</h4>

<p>Another source of problems are shared objects. If we share an object between threads and then execute methods of that object in different threads we have to know exactly whether these operations are all <em>thread-safe</em> (that is, whether they can be executed in parallel from multiple threads). </p>

<p>A simple example, which I saw in real code, shares a stream between two threads. The worker thread is reading from the stream and doing something with the data (it doesn’t matter what). The main thread is monitoring the progress by tracking stream’s <code>Position</code> and updating a progress bar on the user interface. </p>

<p>In pseudo-code, these two threads are executing following operations on a shared stream. </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="k">var</code> 
<code class="lineno">2 </code>  <code class="n">data</code><code class="o">:</code> <code class="n">TStream</code><code class="o">;</code> 
<code class="lineno">3 </code>   
<code class="lineno">4 </code><code class="c1">// worker thread </code>
<code class="lineno">5 </code><code class="n">data</code><code class="o">.</code><code class="n">Read</code><code class="p">(</code><code class="o">...</code><code class="p">)</code><code class="o">;</code> 
<code class="lineno">6 </code><code class="c1">// main thread </code>
<code class="lineno">7 </code><code class="n">UpdatePosition</code><code class="p">(</code><code class="n">data</code><code class="o">.</code><code class="n">Position</code> <code class="o">/</code> <code class="n">data</code><code class="o">.</code><code class="n">Size</code><code class="p">)</code><code class="o">;</code>   
</pre></div>

</figure>

<p>The problem here is easy to overlook as we perceive all operations on the shared stream as <em>reading</em>. In reality, this is not so. Let’s look at them in more detail. </p>

<p><code>Read</code> reads data from a stream’s <em>current position</em> and then <strong>updates</strong> that current position. </p>

<p><code>Position</code> just reads the current position. </p>

<p><code>Size</code> is the worst of them all. Internally it is implemented as three <code>Seek</code> operations. </p>

<figure class="code" dir="ltr">
<div class="highlight"><pre><code></code><code class="lineno">1 </code><code class="nb">Pos</code> <code class="o">:=</code> <code class="nb">Seek</code><code class="p">(</code><code class="mi">0</code><code class="o">,</code> <code class="n">soCurrent</code><code class="p">)</code><code class="o">;</code> 
<code class="lineno">2 </code><code class="bp">Result</code> <code class="o">:=</code> <code class="nb">Seek</code><code class="p">(</code><code class="mi">0</code><code class="o">,</code> <code class="n">soEnd</code><code class="p">)</code><code class="o">;</code> 
<code class="lineno">3 </code><code class="nb">Seek</code><code class="p">(</code><code class="nb">Pos</code><code class="o">,</code> <code class="n">soBeginning</code><code class="p">)</code><code class="o">;</code> 
</pre></div>

</figure>

<p>The problem here is that <code>Seek</code> <strong>modifies</strong> the <em>current position</em>. By calling <code>Size</code> in one thread we can change the current position just as the other thread starts reading from the stream. That will cause wrong data to be read from the stream. </p>

<p>The morale here is simple. Sharing data between thread is <strong>always</strong> dangerous.</p>



</div>
</body>

<!-- Mirrored from www.omnithreadlibrary.com/book/chap04.html by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 19 Oct 2025 22:28:24 GMT -->
</html>
